{"version":3,"file":"RangeStream.js","sourceRoot":"","sources":["../../../../../src/_utils/stream/RangeStream.ts"],"names":[],"mappings":";;;AAAA,8BAAgC;AAChC,iCAAmC;AAEnC,IAAM,KAAK,GAAG,MAAM,CAAC,gBAAgB,CAAC,CAAC;AAEvC;IAAiC,uCAAS;IAKtC,qBAAqB,WAAmB,EAAW,SAAiB,EAAW,YAAoB;QAAnG,YACI,iBAAO,SAUV;QAXoB,iBAAW,GAAX,WAAW,CAAQ;QAAW,eAAS,GAAT,SAAS,CAAQ;QAAW,kBAAY,GAAZ,YAAY,CAAQ;QAE/F,KAAI,CAAC,aAAa,GAAG,CAAC,CAAC;QACvB,KAAI,CAAC,QAAQ,GAAG,KAAK,CAAC;QACtB,KAAI,CAAC,MAAM,GAAG,KAAK,CAAC;QACpB,KAAI,CAAC,EAAE,CAAC,KAAK,EAAE;QAEf,CAAC,CAAC,CAAC;QACH,KAAI,CAAC,EAAE,CAAC,QAAQ,EAAE;QAElB,CAAC,CAAC,CAAC;;IACP,CAAC;IAEM,4BAAM,GAAb,UAAc,QAAoB;QAE9B,QAAQ,EAAE,CAAC;IACf,CAAC;IAEM,gCAAU,GAAjB,UAAkB,KAAa,EAAE,SAAiB,EAAE,QAAoB;QACpE,IAAI,CAAC,aAAa,IAAI,KAAK,CAAC,MAAM,CAAC;QAGnC,EAAE,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC;YAChB,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;gBACf,KAAK,CAAC,iBAAiB,CAAC,CAAC;gBACzB,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;gBACnB,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACpB,CAAC;YAAC,IAAI,CAAC,CAAC;gBACJ,KAAK,CAAC,wCAAwC,CAAC,CAAC;gBAChD,IAAI,CAAC,GAAG,EAAE,CAAC;YACf,CAAC;QACL,CAAC;QAAC,IAAI,CAAC,CAAC;YACJ,EAAE,CAAC,CAAC,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;gBAExC,IAAI,UAAU,GAAG,CAAC,CAAC;gBACnB,IAAI,QAAQ,GAAG,KAAK,CAAC,MAAM,GAAG,CAAC,CAAC;gBAEhC,UAAU,GAAG,IAAI,CAAC,WAAW,GAAG,CAAC,IAAI,CAAC,aAAa,GAAG,KAAK,CAAC,MAAM,CAAC,CAAC;gBACpE,EAAE,CAAC,CAAC,UAAU,GAAG,CAAC,CAAC,CAAC,CAAC;oBACjB,UAAU,GAAG,CAAC,CAAC;gBACnB,CAAC;gBAED,EAAE,CAAC,CAAC,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC;oBACtC,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;oBACrB,QAAQ,GAAG,KAAK,CAAC,MAAM,GAAG,CAAC,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC;gBACpE,CAAC;gBAED,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,UAAU,EAAE,QAAQ,GAAG,CAAC,CAAC,CAAC,CAAC;gBAEjD,EAAE,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC;oBAEhB,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;oBACnB,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;oBAChB,IAAI,CAAC,GAAG,EAAE,CAAC;gBACf,CAAC;YACL,CAAC;YAAC,IAAI,CAAC,CAAC;YAGR,CAAC;QACL,CAAC;QAED,QAAQ,EAAE,CAAC;IACf,CAAC;IACL,kBAAC;AAAD,CAAC,AApED,CAAiC,kBAAS,GAoEzC;AApEY,kCAAW","sourcesContent":["import * as debug_ from \"debug\";\nimport { Transform } from \"stream\";\n\nconst debug = debug_(\"r2:RangeStream\");\n\nexport class RangeStream extends Transform {\n    private bytesReceived: number;\n    private finished: boolean;\n    private closed: boolean;\n\n    constructor(readonly streamBegin: number, readonly streamEnd: number, readonly streamLength: number) {\n        super();\n        this.bytesReceived = 0;\n        this.finished = false;\n        this.closed = false;\n        this.on(\"end\", () => {\n            // debug(\"------ RangeStream END\");\n        });\n        this.on(\"finish\", () => {\n            // debug(\"------ RangeStream FINISH\");\n        });\n    }\n\n    public _flush(callback: () => void): void {\n        // debug(\"FLUSH\");\n        callback();\n    }\n\n    public _transform(chunk: Buffer, _encoding: string, callback: () => void): void {\n        this.bytesReceived += chunk.length;\n        // debug(`_transform bytesReceived ${this.bytesReceived}`);\n\n        if (this.finished) {\n            if (!this.closed) {\n                debug(\"???? CLOSING...\");\n                this.closed = true;\n                this.push(null);\n            } else {\n                debug(\"???? STILL PIPE CALLING _transform ??!\");\n                this.end();\n            }\n        } else {\n            if (this.bytesReceived > this.streamBegin) {\n\n                let chunkBegin = 0;\n                let chunkEnd = chunk.length - 1;\n\n                chunkBegin = this.streamBegin - (this.bytesReceived - chunk.length);\n                if (chunkBegin < 0) {\n                    chunkBegin = 0;\n                }\n\n                if (this.bytesReceived > this.streamEnd) {\n                    this.finished = true;\n                    chunkEnd = chunk.length - (this.bytesReceived - this.streamEnd);\n                }\n                // console.log(`CHUNK: ${chunkBegin}-${chunkEnd}/${chunk.length}`);\n                this.push(chunk.slice(chunkBegin, chunkEnd + 1));\n\n                if (this.finished) {\n                    // debug(\"FINISHING...\");\n                    this.closed = true;\n                    this.push(null);\n                    this.end();\n                }\n            } else {\n                // NOOP\n                // no call to this.push(), we skip the entire current chunk buffer\n            }\n        }\n\n        callback();\n    }\n}\n"]}